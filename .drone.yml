---
kind: pipeline
name: validate

steps:
  - name: lint
    image: sdesbure/yamllint:latest
    commands:
      - yamllint -c ./.yamllint .

  - name: docker-compose
    image: tmaier/docker-compose:latest
    commands:
      - mv prd-esphome-app.env.example prd-esphome-app.env
      - docker-compose config -q

---
kind: pipeline
name: test

steps:
  - name: latest
    image: esphome/esphome:latest
    pull: always
    entrypoint:
      - /bin/bash
    command:
      - -c
      - find /drone/src/config -maxdepth 1 -type f -name "*.yaml" ! -name "secrets.yaml" -print0 | while IFS= read -r -d '' file ; do esphome "$file" config ; done

  - name: beta
    image: esphome/esphome:beta
    pull: always
    failure: ignore
    commands:
      - find ./config -maxdepth 1 -type f -name "*.yaml" ! -name "secrets.yaml" -print0 | while IFS= read -r -d '' file ; do esphome "$file" config ; done
